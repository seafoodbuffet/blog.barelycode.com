---
layout: post
title: How clock drift nearly killed my NAS
tags:
  - nas
  - synology
  - sysadmin
  - linux
---

I recently got a Synology NAS (a DS213j). What i had hoped for was an
appliance-like experience with security to boot. Being security conscious,
I was enable to enable two-factor authentication. Synology uses a
[Time-based one time password](http://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm)
, or TOTP for short, where you enter your username/password into the interface,
then you enter a time-dependent six-digit code. The code is generated on a
hardware token or in my case, a mobile app.

A combination of factors made my NAS completely inaccessible to me, so what happened?

  * NTP was installed on the NAS but failed to update the time.
  This made the TOTP calculations in the NAS device NOT match those
  generated by my mobile app. This meant I was always failing to enter a
  valid One-time Password.

  * Auto-blocking was enabled on the NAS (wherein it bans an IP address after
  repeated failed logins). This is a good security practice.

  * Unfortunately, the default setting for auto-blocking makes these blocks
  ***PERMANENT***, meaning once banned, you're always banned until an
  administrator unblocks your IP. If your admin account is permanently banned,
  then you effectively have locked yourself out of your house with no way in.

Luckily, this fortress had a backdoor. In my case, the solution required an
SSH login into the NAS (luckily I had remembered to enable SSH login and SSH
login bypasses the two-factor authentication). Once logged in via command-line,
I could then manually update the clock using ntpdate. Had I not enabled SSH,
I totally believe that I would have been totally screwed. Had I not had
another computer that I could use to login, I could have just changed my
machine's local IP, but because of the clock issue,Â I would never have been
able to login through the web ui.</b></p><p>In short, always leave an expiry
on IP blocking, it might be less secure, but you won't have to factory-reset
your NAS.

![autoblocking bad]({{ site.url }}/assets/autoblocking.png)
***Make sure you leave yourself some room for error here***
